# cvdupdate

Alpine-based container for [`cvdupdate`](https://github.com/Cisco-Talos/cvdupdate):
> A tool to download and update clamav databases and database patch files for the 
> purposes of hosting your own database mirror.

## About

By default, this image will download and/or serve databases from the `/opt/db`
container path.


## Usage

### Change database directory

To change the default clamav databases path, the target directory **must** exist
before `cvdupdate` attempts to utilize it:
```sh
mkdir -p /path/to/databases
cvdupdate config set -d /path/to/databases
```

### Update clamav databases

```sh
cvdupdate update
```

### Serve databases
```sh
cvdupdate serve
```

### Schedule recurring updates
To run recurring cron jobs on Alpine, an **executeable** script **with no extension**
can be placed in one of `/etc/periodic/{15min, daily, hourly, weekly}`. **ANY** script
run in this manner **must** begin with a [shebang](https://en.wikipedia.org/wiki/Shebang_(Unix))
and an [interpreter directive](https://en.wikipedia.org/wiki/Interpreter_directive). I.e.
`#!/bin/sh`

For example, to update the clamav mirror every hour:
```sh
#!/bin/sh
# /etc/periodic/hourly/cvdupdate
cvdupdate update
```

```sh
chmod +x /etc/periodic/hourly/cvdupdate
cvdupdate update # run once immediately
crond -f -l 8
```

### GKE Scheduled updates and mirror
```yaml
...
      containers:
        - name: cvdupdate-server
          image: cvdupdate:latest
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh", "-c"]
          args:
            - |
              cvdupdate config set -d /opt/db
              cvdupdate serve
          volumeMounts:
            - name: data
              mountPath: /opt/db
        - name: cvdupdate-cron
          image: cvdupdate:latest
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "#!/bin/sh" >> /etc/periodic/hourly/cvdupdate
              echo "cvdupdate update" >> /etc/periodic/hourly/cvdupdate
              chmod +x /etc/periodic/hourly/cvdupdate
              cvdupdate config set -d /opt/db
              cvdupdate update
              crond -f -l 8
          volumeMounts:
            - name: data
              mountPath: /opt/db
      volumes:
        - name: data
          emptyDir: {}
```
